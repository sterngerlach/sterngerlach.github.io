<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="SternGerlach" />
  <title>SO(3)とSE(3)についてのメモ書き (その2)</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <link rel="stylesheet" href="style.css" />
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">SO(3)とSE(3)についてのメモ書き (その2)</h1>
<p class="author">SternGerlach</p>
</header>
<!--
 pandoc -s --filter pandoc-crossref -M "crossrefYaml=./crossref_config.yaml" -f markdown -t html5 --mathjax --css style.css lie-2.md > lie-2.html
-->
<p><a href="./index.html">ホームに戻る</a></p>
<h1 id="このページについて">このページについて</h1>
<p>3次元の回転を表すリー群<span
class="math inline">\(\mathrm{SO}(3)\)</span>と、リー代数<span
class="math inline">\(\mathfrak{so}(3)\)</span>に関する、自分用のメモ書きです。</p>
<h2 id="mathrmso3の微分"><span
class="math inline">\(\mathrm{SO}(3)\)</span>の微分</h2>
<p>リー代数<span class="math inline">\(\boldsymbol{\phi} \in
\mathfrak{so}(3)\)</span>と、それに対応する回転行列<span
class="math inline">\(\mathbf{C} = \exp(\boldsymbol{\phi}^\wedge) \in
\mathrm{SO}(3)\)</span>を考える。 <span
class="math inline">\(\mathbf{C}\)</span>の<span
class="math inline">\(\boldsymbol{\phi}\)</span>に関する偏微分は、幾つかの方法で計算できる。</p>
<p><span class="math inline">\(\boldsymbol{\phi}\)</span>の各要素を<span
class="math inline">\(\phi_i\)</span> (<span class="math inline">\(0 \le
i \le 2\)</span>)とする。 <span
class="math inline">\(\mathbf{C}\)</span>は<span class="math inline">\(3
\times 3\)</span>行列であるため、<span
class="math inline">\(\phi_i\)</span>に関する偏微分<span
class="math inline">\(\cfrac{\partial \mathbf{C}}{\partial
\phi_i}\)</span>も<span class="math inline">\(3 \times
3\)</span>行列となる。 この偏微分は、<span
class="math inline">\(\phi_i\)</span>に微小な摂動<span
class="math inline">\(\Delta \phi_i\)</span>を加えたときに、<span
class="math inline">\(\mathbf{C}\)</span>がどのくらい変化するのかを表している。</p>
<p>あるいは、3次実ベクトル<span
class="math inline">\(\mathbf{p}\)</span>について、<span
class="math inline">\(\mathbf{C} \mathbf{p}\)</span>の<span
class="math inline">\(\boldsymbol{\phi}\)</span>に関する偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>を考えることもできる。 <span
class="math inline">\(\mathbf{C} \mathbf{p}\)</span>は3次ベクトル、<span
class="math inline">\(\boldsymbol{\phi}\)</span>も3次ベクトルであるから、この偏微分は<span
class="math inline">\(3 \times 3\)</span>行列になる。</p>
<h2 id="下準備-mathbfso3に摂動を加える">下準備: <span
class="math inline">\(\mathbf{SO}(3)\)</span>に摂動を加える</h2>
<p>BCH (Baker-Campbell-Hausdorff) の公式を使うと、2つのリー代数<span
class="math inline">\(\boldsymbol{\phi}_1, \boldsymbol{\phi}_2 \in
\mathfrak{so}(3)\)</span>について、以下の近似式が得られる。</p>
<p><span class="math display">\[
  \ln(\exp(\boldsymbol{\phi}_1^\wedge)
\exp(\boldsymbol{\phi}_2^\wedge))^\vee
  \approx \left\{ \begin{array}{cc}
    \mathbf{J}_l(\boldsymbol{\phi}_2)^{-1} \boldsymbol{\phi}_1 +
\boldsymbol{\phi}_2
    &amp; \text{$\boldsymbol{\phi}_1$が小さいとき} \\
    \mathbf{J}_r(\boldsymbol{\phi}_1)^{-1} \boldsymbol{\phi}_2 +
\boldsymbol{\phi}_1
    &amp; \text{$\boldsymbol{\phi}_2$が小さいとき}
    \end{array} \right.
\]</span></p>
<p>2つの回転行列<span
class="math inline">\(\exp(\boldsymbol{\phi}_1^\wedge)\)</span>、<span
class="math inline">\(\exp(\boldsymbol{\phi}_2^\wedge)\)</span>を合成して、新たな回転行列<span
class="math inline">\(\exp(\boldsymbol{\phi}_1^\wedge)
\exp(\boldsymbol{\phi}_2^\wedge)\)</span>を作成する。
この新たな回転に対応するリー代数<span
class="math inline">\(\ln(\exp(\boldsymbol{\phi}_1^\wedge)
\exp(\boldsymbol{\phi}_2^\wedge))^\vee\)</span>は、もし<span
class="math inline">\(\boldsymbol{\phi}_1\)</span>が小さい回転を表していれば上側、<span
class="math inline">\(\boldsymbol{\phi}_2\)</span>が小さい回転を表していれば下側のように近似される。</p>
<p>ヤコビ行列<span
class="math inline">\(\mathbf{J}_l(\boldsymbol{\phi})\)</span>と<span
class="math inline">\(\mathbf{J}_r(\boldsymbol{\phi})\)</span>は次のように定義される。
ただし、<span class="math inline">\(\boldsymbol{\phi} = \phi
\mathbf{a}\)</span>、<span class="math inline">\(\phi = |
\boldsymbol{\phi} |\)</span>、<span class="math inline">\(\mathbf{a} =
\boldsymbol{\phi} / \phi\)</span>である。 <span
class="math inline">\(\phi\)</span>は<span
class="math inline">\(\boldsymbol{\phi}\)</span>のノルム、<span
class="math inline">\(\mathbf{a}\)</span>はノルム1に正規化されたベクトルである(<a
href="./lie-1.html">前回のメモ</a>を参照)。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \mathbf{J}_l(\boldsymbol{\phi}) &amp;=&amp; \frac{\sin \phi}{\phi}
\mathbf{I}
      + \left( 1 - \frac{\sin \phi}{\phi} \right) \mathbf{a}
\mathbf{a}^\top
      + \frac{1 - \cos \phi}{\phi} \mathbf{a}^\wedge \\
    \mathbf{J}_r(\boldsymbol{\phi}) &amp;=&amp; \frac{\sin \phi}{\phi}
\mathbf{I}
      + \left( 1 - \frac{\sin \phi}{\phi} \right) \mathbf{a}
\mathbf{a}^\top
      - \frac{1 - \cos \phi}{\phi} \mathbf{a}^\wedge
  \end{eqnarray}
\]</span></p>
<p>2つのヤコビ行列<span
class="math inline">\(\mathbf{J}_l\)</span>、<span
class="math inline">\(\mathbf{J}_r\)</span>の間には、次の関係が成り立つ。</p>
<p><span class="math display">\[
  \mathbf{J}_r(\boldsymbol{\phi}) = \mathbf{J}_l(-\boldsymbol{\phi})
\]</span></p>
<p>逆行列<span class="math inline">\(\mathbf{J}_l^{-1}\)</span>、<span
class="math inline">\(\mathbf{J}_r^{-1}\)</span>は、次のように表される。
<span class="math inline">\(\cot \theta = \cfrac{1}{\tan \theta} =
\cfrac{\cos \theta}{\sin \theta}\)</span>である。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \mathbf{J}_l(\boldsymbol{\phi})^{-1} &amp;=&amp; \frac{\phi}{2} \cot
\frac{\phi}{2} \mathbf{I}
      + \left( 1 - \frac{\phi}{2} \cot \frac{\phi}{2} \right) \mathbf{a}
\mathbf{a}^\top
      - \frac{\phi}{2} \mathbf{a}^\wedge \\
    \mathbf{J}_r(\boldsymbol{\phi})^{-1} &amp;=&amp; \frac{\phi}{2} \cot
\frac{\phi}{2} \mathbf{I}
      + \left( 1 - \frac{\phi}{2} \cot \frac{\phi}{2} \right) \mathbf{a}
\mathbf{a}^\top
      + \frac{\phi}{2} \mathbf{a}^\wedge
  \end{eqnarray}
\]</span></p>
<p>上式を基に、<span
class="math inline">\(\boldsymbol{\phi}\)</span>に摂動<span
class="math inline">\(\Delta
\boldsymbol{\phi}\)</span>を加えたとき、回転行列<span
class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>がどのように変化するのかを考える。
回転<span
class="math inline">\(\mathbf{C}\)</span>に対して、<strong>左側から</strong>摂動<span
class="math inline">\(\exp(\Delta
\boldsymbol{\phi}^\wedge)\)</span>を加えると、新たな回転は次のようになる。</p>
<p><span class="math display">\[
  \ln(\exp(\Delta \boldsymbol{\phi}^\wedge)
\exp(\boldsymbol{\phi}^\wedge))^\vee
  \approx \mathbf{J}_l(\boldsymbol{\phi})^{-1} \Delta \boldsymbol{\phi}
+ \boldsymbol{\phi}
\]</span></p>
<p>続いて、回転<span
class="math inline">\(\mathbf{C}\)</span>に対して、<strong>右側から</strong>摂動<span
class="math inline">\(\exp(\Delta
\boldsymbol{\phi}^\wedge)\)</span>を加えると、新たな回転は次のようになる。</p>
<p><span class="math display">\[
  \ln(\exp(\boldsymbol{\phi}^\wedge) \exp(\Delta
\boldsymbol{\phi}^\wedge))^\vee
  \approx \mathbf{J}_r(\boldsymbol{\phi})^{-1} \Delta \boldsymbol{\phi}
+ \boldsymbol{\phi}
\]</span></p>
<p>次のようにも書ける。</p>
<p><span class="math display">\[
  \exp(\Delta \boldsymbol{\phi}^\wedge) \exp(\boldsymbol{\phi}^\wedge)
  \approx \exp((\mathbf{J}_l(\boldsymbol{\phi})^{-1} \Delta
\boldsymbol{\phi}
    + \boldsymbol{\phi})^\wedge)
\]</span></p>
<p><span class="math display">\[
  \exp(\boldsymbol{\phi}^\wedge) \exp(\Delta \boldsymbol{\phi}^\wedge)
  \approx \exp((\mathbf{J}_r(\boldsymbol{\phi})^{-1} \Delta
\boldsymbol{\phi}
    + \boldsymbol{\phi})^\wedge)
\]</span></p>
<h2 id="偏微分の計算-その1">偏微分の計算 (その1)</h2>
<p><span class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>の<span
class="math inline">\(\phi_i\)</span>に関する偏微分は、次のように表せる。</p>
<p><span class="math display">\[
  \frac{\partial \mathbf{C}}{\partial \phi_i}
  = \frac{\partial \exp(\boldsymbol{\phi}^\wedge)}{\partial \phi_i}
  = \lim_{h \to 0} \frac{\exp((\boldsymbol{\phi} + h
\mathbf{1}_i)^\wedge)
    - \exp(\boldsymbol{\phi}^\wedge)}{h}
\]</span></p>
<p><span class="math inline">\(\mathbf{1}_i\)</span>は<span
class="math inline">\(\boldsymbol{\phi}\)</span>と同様に3次ベクトルであり、<span
class="math inline">\(i\)</span>番目の要素が<span
class="math inline">\(1\)</span>で、他は全て<span
class="math inline">\(0\)</span>である。 従って<span
class="math inline">\(\boldsymbol{\phi} + h
\mathbf{1}_i\)</span>は、<span
class="math inline">\(\boldsymbol{\phi}\)</span>の<span
class="math inline">\(i\)</span>番目の要素に、微小な変動<span
class="math inline">\(h\)</span>を加えたものである。</p>
<ul>
<li><p><span
class="math inline">\(\mathbf{J}_l(\boldsymbol{\phi})\)</span>を使うと、<span
class="math inline">\(\exp((\boldsymbol{\phi} + h
\mathbf{1}_i)^\wedge)\)</span>の部分は、次のように近似できる。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \exp((\boldsymbol{\phi} + h \mathbf{1}_i)^\wedge)
    &amp;=&amp; \exp((\boldsymbol{\phi} +
\mathbf{J}_l(\boldsymbol{\phi})^{-1}
      \underbrace{h \mathbf{J}_l(\boldsymbol{\phi})
      \mathbf{1}_i}_{\Delta \boldsymbol{\phi}})^\wedge) \\
    &amp;\approx&amp; \exp((h \mathbf{J}_l(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge)
      \exp(\boldsymbol{\phi}^\wedge) \\
    &amp;\approx&amp; \left( \mathbf{I} + h
(\mathbf{J}_l(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge \right)
      \exp(\boldsymbol{\phi}^\wedge)
  \end{eqnarray}
\]</span></p>
<p>最後の式変形は、行列指数関数<span
class="math inline">\(\exp(\mathbf{A})\)</span>の定義に基づいている。</p>
<p><span class="math display">\[
  \exp(\mathbf{A}) = \mathbf{I} + \mathbf{A} + \frac{1}{2!} \mathbf{A}^2
    + \frac{1}{3!} \mathbf{A}^3 + \cdots
    = \sum_{n = 0}^\infty \frac{1}{n!} \mathbf{A}^n
\]</span></p>
<p>ここでは<span
class="math inline">\(h\)</span>が微小、言い換えると、<span
class="math inline">\(\mathbf{A} = (h \mathbf{J}_l(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge\)</span>が微小である。 従って、<span
class="math inline">\(\mathbf{A}\)</span>に関する項だけを残して、<span
class="math inline">\(\mathbf{A}^2\)</span>以降の項は無視できる。</p>
<p>この近似を偏微分の定義に代入すれば、次が得られる。</p>
<p><span class="math display">\[
  \frac{\left( \mathbf{I} + h (\mathbf{J}_l(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge \right)
    \exp(\boldsymbol{\phi}^\wedge) - \exp(\boldsymbol{\phi}^\wedge)}{h}
  = (\mathbf{J}_l(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge
\exp(\boldsymbol{\phi}^\wedge)
\]</span></p></li>
<li><p>一方、<span
class="math inline">\(\mathbf{J}_l(\boldsymbol{\phi})\)</span>を使うと、<span
class="math inline">\(\exp((\boldsymbol{\phi} + h
\mathbf{1}_i)^\wedge)\)</span>の部分は、次のように近似できる。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \exp((\boldsymbol{\phi} + h \mathbf{1}_i)^\wedge)
    &amp;=&amp; \exp((\boldsymbol{\phi} +
\mathbf{J}_r(\boldsymbol{\phi})^{-1}
      \underbrace{h \mathbf{J}_r(\boldsymbol{\phi})
      \mathbf{1}_i}_{\Delta \boldsymbol{\phi}})^\wedge) \\
    &amp;\approx&amp; \exp(\boldsymbol{\phi}^\wedge)
      \exp((h \mathbf{J}_r(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge) \\
    &amp;\approx&amp; \exp(\boldsymbol{\phi}^\wedge)
      \left( \mathbf{I} + (h \mathbf{J}_r(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge \right)
  \end{eqnarray}
\]</span></p>
<p>この近似を偏微分の定義に代入すれば、次が得られる。</p>
<p><span class="math display">\[
  \frac{\exp(\boldsymbol{\phi}^\wedge)
    \left( \mathbf{I} + (h \mathbf{J}_r(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge \right)
    - \exp(\boldsymbol{\phi}^\wedge)}{h}
  = \exp(\boldsymbol{\phi}^\wedge) (\mathbf{J}_r(\boldsymbol{\phi})
\mathbf{1}_i)^\wedge
\]</span></p></li>
</ul>
<p>以上より、<span class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>の<span
class="math inline">\(\phi_i\)</span>に関する偏微分は、次のようになる。
3次ベクトル<span class="math inline">\(\mathbf{1}_i\)</span>は、<span
class="math inline">\(i\)</span>番目の要素が<span
class="math inline">\(1\)</span>で、他は全て<span
class="math inline">\(0\)</span>である。</p>
<p><span class="math display">\[
  \frac{\partial \mathbf{C}}{\partial \phi_i}
  = \left\{ \begin{array}{cc}
    (\mathbf{J}_l(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge \mathbf{C}
    &amp; \text{$\mathbf{J}_l$を使うとき} \\
    \mathbf{C} (\mathbf{J}_r(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge
    &amp; \text{$\mathbf{J}_r$を使うとき} \end{array} \right.
\]</span></p>
<p>上式を使うと、ある3次実ベクトル<span class="math inline">\(\mathbf{p}
\in \mathbb{R}^3\)</span>について、<span
class="math inline">\(\mathbf{C} \mathbf{p}\)</span>の<span
class="math inline">\(\boldsymbol{\phi}\)</span>による偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>が求められる。 偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>は、回転行列<span
class="math inline">\(\mathbf{C}\)</span>を微小に変動させたとき、回転の結果<span
class="math inline">\(\mathbf{C}
\mathbf{p}\)</span>がどのぐらい動くのかを表している。</p>
<p><span class="math inline">\(\mathbf{C} \mathbf{p}\)</span>の<span
class="math inline">\(\phi_i\)</span>に関する偏微分は、右端に<span
class="math inline">\(\mathbf{p}\)</span>を足せば、次のようになる。</p>
<p><span class="math display">\[
  \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \phi_i}
  = \left\{ \begin{array}{cc}
    (\mathbf{J}_l(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge \mathbf{C}
\mathbf{p}
    &amp; \text{$\mathbf{J}_l$を使うとき} \\
    \mathbf{C} (\mathbf{J}_r(\boldsymbol{\phi}) \mathbf{1}_i)^\wedge
\mathbf{p}
    &amp; \text{$\mathbf{J}_r$を使うとき} \end{array} \right.
\]</span></p>
<p><span class="math inline">\(\mathbf{a}^\wedge
\mathbf{b}\)</span>は、2つのベクトルの外積<span
class="math inline">\(\mathbf{a} \times
\mathbf{b}\)</span>を表すから、外積と同様に<span
class="math inline">\(\mathbf{a}^\wedge \mathbf{b} = -\mathbf{b}^\wedge
\mathbf{a}\)</span>が成り立つ。
この関係を使うと、上式は次のように書ける。</p>
<p><span class="math display">\[
  \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \phi_i}
  = \left\{ \begin{array}{cc}
    - (\mathbf{C} \mathbf{p})^\wedge \mathbf{J}_l(\boldsymbol{\phi})
\mathbf{1}_i
    &amp; \text{$\mathbf{J}_l$を使うとき} \\
    -\mathbf{C} \mathbf{p}^\wedge \mathbf{J}_r(\boldsymbol{\phi})
\mathbf{1}_i
    &amp; \text{$\mathbf{J}_r$を使うとき} \end{array} \right.
\]</span></p>
<p><span class="math inline">\((\mathbf{C} \mathbf{p})^\wedge =
\mathbf{C} \mathbf{p}^\wedge
\mathbf{C}^\top\)</span>の関係が成り立つから、<span
class="math inline">\((\mathbf{C} \mathbf{p})^\wedge\)</span>と<span
class="math inline">\(\mathbf{C}
\mathbf{p}^\wedge\)</span>は別物である。</p>
<p><span class="math inline">\((\mathbf{C} \mathbf{p})^\wedge
\mathbf{J}_l(\boldsymbol{\phi}) \mathbf{1}_i\)</span>は、<span
class="math inline">\(3 \times 3\)</span>行列<span
class="math inline">\((\mathbf{C} \mathbf{p})^\wedge
\mathbf{J}_l(\boldsymbol{\phi})\)</span>の<span
class="math inline">\(i\)</span>列目のベクトルである。 同様に、<span
class="math inline">\(\mathbf{C} \mathbf{p}^\wedge
\mathbf{J}_r(\boldsymbol{\phi}) \mathbf{1}_i\)</span>は、<span
class="math inline">\(3 \times 3\)</span>行列<span
class="math inline">\(\mathbf{C} \mathbf{p}^\wedge
\mathbf{J}_r(\boldsymbol{\phi})\)</span>の<span
class="math inline">\(i\)</span>列目のベクトルである。</p>
<p>以上より、全ての<span
class="math inline">\(i\)</span>について、上記の3次ベクトルを<strong>列方向に</strong>並べれば、<span
class="math inline">\(3 \times 3\)</span>行列の偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>が得られる。</p>
<p><span class="math display">\[
  \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \boldsymbol{\phi}}
  = \left\{ \begin{array}{cc}
    - (\mathbf{C} \mathbf{p})^\wedge \mathbf{J}_l(\boldsymbol{\phi})
    &amp; \text{$\mathbf{J}_l$を使うとき} \\
    -\mathbf{C} \mathbf{p}^\wedge \mathbf{J}_r(\boldsymbol{\phi})
    &amp; \text{$\mathbf{J}_r$を使うとき} \end{array} \right.
\]</span></p>
<h2 id="偏微分の計算-その2">偏微分の計算 (その2)</h2>
<p>上記の偏微分<span class="math inline">\(\cfrac{\partial
\mathbf{C}}{\partial \phi_i}\)</span>、あるいは<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>を求めるためには、ヤコビ行列<span
class="math inline">\(\mathbf{J}_l\)</span>あるいは<span
class="math inline">\(\mathbf{J}_r\)</span>の計算が必要である。
しかも、このヤコビ行列を計算するためには、<span
class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>を<span
class="math inline">\(\boldsymbol{\phi} =
\ln(\mathbf{C})^\vee\)</span>に一旦変換しなければならない(<a
href="./lie-1.html">前回のメモ</a>を参照)。</p>
<p>そこで、上記とは別のアプローチで、偏微分<span
class="math inline">\(\cfrac{\partial \mathbf{C}}{\partial
\phi_i}\)</span>、あるいは<span class="math inline">\(\cfrac{\partial
(\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>を求めてみる。</p>
<p>先ほどは、<span class="math inline">\(\phi_i\)</span>の方向に<span
class="math inline">\(\boldsymbol{\phi}\)</span>を摂動したときの回転行列を、<span
class="math inline">\(\exp((\boldsymbol{\phi} + h
\mathbf{1}_i)^\wedge)\)</span>で表現したが、ここでは<span
class="math inline">\(\exp((h \mathbf{1}_i)^\wedge)
\exp(\mathbf{C})\)</span>、あるいは<span
class="math inline">\(\exp(\mathbf{C}) \exp((h
\mathbf{1}_i)^\wedge)\)</span>と表すことにする。
前者は<strong>左側から</strong>、後者は<strong>右側から</strong>、<span
class="math inline">\(h
\mathbf{1}_i\)</span>に対応する微小な回転行列<span
class="math inline">\(\exp((h \mathbf{1}_i)^\wedge)\)</span>を適用する。
先ほどと異なるのは、次のような点である。</p>
<ul>
<li><p>先ほどの方法: <span
class="math inline">\(\boldsymbol{\phi}\)</span>に摂動<span
class="math inline">\(h \mathbf{1}_i\)</span>を加えた後、回転行列<span
class="math inline">\(\exp((\boldsymbol{\phi} + h
\mathbf{1}_i)^\wedge)\)</span>に変換する</p></li>
<li><p>ここでの方法: 摂動を回転行列<span class="math inline">\(\exp((h
\mathbf{1}_i)^\wedge)\)</span>に変換した後、元の回転行列<span
class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>に適用する</p></li>
<li><p><strong>左側から</strong>適用する場合、偏微分<span
class="math inline">\(\cfrac{\partial \mathbf{C}}{\partial
\phi_i}\)</span>と<span class="math inline">\(\cfrac{\partial
(\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>は次のように書ける。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \frac{\partial \mathbf{C}}{\partial \phi_i}
    &amp;=&amp; \lim_{h \to 0} \frac{\exp((h \mathbf{1}_i)^\wedge)
\mathbf{C} - \mathbf{C}}{h} \\
    &amp;\approx&amp; \lim_{h \to 0} \frac{\left(
      \mathbf{I} + (h \mathbf{1}_i)^\wedge \right) \mathbf{C} -
\mathbf{C}}{h} \\
    &amp;=&amp; (\mathbf{1}_i)^\wedge \mathbf{C}
  \end{eqnarray}
\]</span></p>
<p>ここでも<span class="math inline">\(\exp(\mathbf{A}) \approx
\mathbf{I} + \mathbf{A}\)</span>のように、<span
class="math inline">\(\exp(\mathbf{A})\)</span>を一次の項までで近似している。</p>
<p>偏微分<span class="math inline">\(\cfrac{\partial (\mathbf{C}
\mathbf{p})}{\partial \phi_i}\)</span>は、上式に<span
class="math inline">\(\mathbf{p}\)</span>を付け足せば、以下のようになる。
<span class="math inline">\(\mathbf{a}^\wedge \mathbf{b} =
-\mathbf{b}^\wedge \mathbf{a}\)</span>である。</p>
<p><span class="math display">\[
  \cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial \phi_i}
  = (\mathbf{1}_i)^\wedge \mathbf{C} \mathbf{p}
  = - \left( \mathbf{C} \mathbf{p} \right)^\wedge \mathbf{1}_i
\]</span></p>
<p><span class="math inline">\(\left( \mathbf{C} \mathbf{p}
\right)^\wedge \mathbf{1}_i\)</span>は、<span class="math inline">\(3
\times 3\)</span>行列<span class="math inline">\((\mathbf{C}
\mathbf{p})^\wedge\)</span>の<span
class="math inline">\(i\)</span>列目のベクトルである。 全ての<span
class="math inline">\(i\)</span>について、上記の3次ベクトルを列方向に並べれば、次のように<span
class="math inline">\(3 \times 3\)</span>の偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>が得られる。</p>
<p><span class="math display">\[
  \cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial \boldsymbol{\phi}}
  = - \left( \mathbf{C} \mathbf{p} \right)^\wedge
\]</span></p></li>
<li><p><strong>右側から</strong>適用する場合、偏微分<span
class="math inline">\(\cfrac{\partial \mathbf{C}}{\partial
\phi_i}\)</span>は次のように書ける。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \frac{\partial \mathbf{C}}{\partial \phi_i}
    &amp;=&amp; \lim_{h \to 0} \frac{\mathbf{C} \exp((h
\mathbf{1}_i)^\wedge) - \mathbf{C}}{h} \\
    &amp;\approx&amp; \lim_{h \to 0} \frac{\mathbf{C} \left(
      \mathbf{I} + (h \mathbf{1}_i)^\wedge \right) - \mathbf{C}}{h} \\
    &amp;=&amp; \mathbf{C} (\mathbf{1}_i)^\wedge
  \end{eqnarray}
\]</span></p>
<p>偏微分<span class="math inline">\(\cfrac{\partial (\mathbf{C}
\mathbf{p})}{\partial \phi_i}\)</span>は、上式に<span
class="math inline">\(\mathbf{p}\)</span>を付け足せば、以下のようになる。</p>
<p><span class="math display">\[
  \cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial \phi_i}
  = \mathbf{C} (\mathbf{1}_i)^\wedge \mathbf{p}
  = - \mathbf{C} \mathbf{p}^\wedge \mathbf{1}_i
\]</span></p>
<p><span class="math inline">\(\mathbf{C} \mathbf{p}^\wedge
\mathbf{1}_i\)</span>は、<span class="math inline">\(3 \times
3\)</span>行列<span class="math inline">\(\mathbf{C}
\mathbf{p}^\wedge\)</span>の<span
class="math inline">\(i\)</span>列目のベクトルである。 全ての<span
class="math inline">\(i\)</span>について、上記の3次ベクトルを列方向に並べれば、次のように<span
class="math inline">\(3 \times 3\)</span>の偏微分<span
class="math inline">\(\cfrac{\partial (\mathbf{C} \mathbf{p})}{\partial
\boldsymbol{\phi}}\)</span>が得られる。</p>
<p><span class="math display">\[
  \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \boldsymbol{\phi}}
  = - \mathbf{C} \mathbf{p}^\wedge
\]</span></p></li>
</ul>
<p>以上より、<span class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>の<span
class="math inline">\(\phi_i\)</span>に関する偏微分は、次のようになる。</p>
<p><span class="math display">\[
  \frac{\partial \mathbf{C}}{\partial \phi_i}
  = \left\{ \begin{array}{cc}
    (\mathbf{1}_i)^\wedge \mathbf{C} &amp; \text{左側から適用するとき}
\\
    \mathbf{C} (\mathbf{1}_i)^\wedge &amp; \text{右側から適用するとき}
\end{array} \right.
\]</span></p>
<p>また、<span class="math inline">\(\mathbf{C}
\mathbf{p}\)</span>の<span
class="math inline">\(\boldsymbol{\phi}\)</span>に関する偏微分は、次のようになる。</p>
<p><span class="math display">\[
  \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \boldsymbol{\phi}}
  = \left\{ \begin{array}{cc}
    - \left( \mathbf{C} \mathbf{p} \right)^\wedge &amp;
\text{左側から適用するとき} \\
    - \mathbf{C} \mathbf{p}^\wedge &amp; \text{右側から適用するとき}
\end{array} \right.
\]</span></p>
<p>先程のアプローチと比較すると、ヤコビ行列<span
class="math inline">\(\mathbf{J}_l\)</span>、<span
class="math inline">\(\mathbf{J}_r\)</span>が消えているので、計算が楽になる。</p>
<h2 id="合成関数の微分">合成関数の微分</h2>
<p>回転行列<span class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>の関数<span
class="math inline">\(L(\mathbf{C})\)</span>を考える。 スカラー関数<span
class="math inline">\(L(\mathbf{C})\)</span>の<span
class="math inline">\(\phi_i\)</span>による微分は、次のようになる。
<span class="math inline">\(C_{ij}\)</span>は、<span
class="math inline">\(\mathbf{C}\)</span>の<span
class="math inline">\((i, j)\)</span>要素である。
ここでは、2つ目のアプローチによる微分を使う。</p>
<p><span class="math display">\[
  \begin{eqnarray}
    \frac{\partial L(\mathbf{C})}{\partial \phi_i}
    &amp;=&amp; \sum_{j = 0}^2 \sum_{k = 0}^2 \frac{\partial
C_{jk}}{\partial \phi_i}
      \frac{\partial L(\mathbf{C})}{\partial C_{jk}} \\
    &amp;=&amp; \sum_{j = 0}^2 \sum_{k = 0}^2 \left( \frac{\partial
\mathbf{C}}{\partial \phi_i} \right)_{jk}
      \left( \frac{\partial L(\mathbf{C})}{\partial \mathbf{C}}
\right)_{jk} \\
    &amp;=&amp; \left\{ \begin{array}{cc}
      \sum_{j = 0}^2 \sum_{k = 0}^2 \left( (\mathbf{1}_i)^\wedge
\mathbf{C} \right)_{jk}
      \left( \frac{\partial L(\mathbf{C})}{\partial \mathbf{C}}
\right)_{jk}
      &amp; \text{左側から適用するとき} \\
      \sum_{j = 0}^2 \sum_{k = 0}^2 \left( \mathbf{C}
(\mathbf{1}_i)^\wedge \right)_{jk}
      \left( \frac{\partial L(\mathbf{C})}{\partial \mathbf{C}}
\right)_{jk}
      &amp; \text{右側から適用するとき} \end{array} \right.
  \end{eqnarray}
\]</span></p>
<p><span
class="math inline">\(L(\mathbf{C})\)</span>は、例えば、ニューラルネットにおける誤差関数となる。
このとき、リー代数<span
class="math inline">\(\boldsymbol{\phi}\)</span>を入力にとって、回転行列<span
class="math inline">\(\mathbf{C} =
\exp(\boldsymbol{\phi}^\wedge)\)</span>を出力するレイヤー(ここでは<span
class="math inline">\(\mathrm{SO}(3)\)</span>レイヤーとする)が、ニューラルネットのなかに組み込まれているとする。
誤差逆伝播法を実施するとき、<span
class="math inline">\(\mathrm{SO}(3)\)</span>レイヤーは後ろの層から、出力に関する残差関数の勾配<span
class="math inline">\(\cfrac{\partial L(\mathbf{C})}{\partial
\mathbf{C}}\)</span>を受け取って、入力に関する勾配<span
class="math inline">\(\cfrac{\partial L(\mathbf{C})}{\partial
\boldsymbol{\phi}}\)</span>の各要素を上記のように計算し、前の層に引き渡すことができる。
<span
class="math inline">\(\mathrm{SO}(3)\)</span>レイヤーは、順伝播のときの計算結果<span
class="math inline">\(\mathbf{C}\)</span>をどこかに保持しておく必要がある。</p>
<p>あるいは、<span class="math inline">\(\mathbf{u} = \mathbf{C}
\mathbf{p}\)</span>の関数<span
class="math inline">\(L(\mathbf{u})\)</span>を考える。 スカラー関数<span
class="math inline">\(L(\mathbf{u})\)</span>の<span
class="math inline">\(\boldsymbol{\phi}\)</span>に関する微分は、連鎖律から次のようになる。
ここでも、2つ目のアプローチによる微分を使っている。</p>
<p><span class="math display">\[
  \frac{\partial L(\mathbf{u})}{\partial \boldsymbol{\phi}}
  = \frac{\partial L(\mathbf{u})}{\partial \mathbf{u}}
    \frac{\partial (\mathbf{C} \mathbf{p})}{\partial \boldsymbol{\phi}}
\\
  = \left\{ \begin{array}{cc}
    - \frac{\partial L(\mathbf{u})}{\partial \mathbf{u}}
    \left( \mathbf{C} \mathbf{p} \right)^\wedge &amp;
\text{左側から適用するとき} \\
    - \frac{\partial L(\mathbf{u})}{\partial \mathbf{u}}
    \mathbf{C} \mathbf{p}^\wedge &amp; \text{右側から適用するとき}
    \end{array} \right.
\]</span></p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a
href="http://asrl.utias.utoronto.ca/~tdb/bib/barfoot_ser17.pdf">State
Estimation for Robotics</a></li>
<li><a href="https://github.com/gaoxiang12/slambook-en">Introduction to
Visual SLAM From Theory to Practice</a></li>
</ul>
</body>
</html>
