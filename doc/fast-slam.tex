
% fast-slam.tex

\documentclass[dvipdfmx,a4paper]{jsarticle}

\usepackage{docmute}
\input{settings}

\usepackage{geometry}
\geometry{left=19.05mm,right=19.05mm,top=19.05mm,bottom=19.05mm}

\title{パーティクルフィルタによるSLAM: FastSLAM 1.0}
\author{にゃーん}
\date{\today}

\begin{document}

\maketitle

\section{パーティクルフィルタによるSLAM}
SLAM問題は、\textbf{オンラインSLAM問題}と\textbf{完全SLAM問題}の2つに分類された。また完全SLAM問題には、オンラインで解く手法とオフラインで解く手法が存在した。\textbf{オンライン}の\textbf{完全SLAM問題}に、\textbf{パーティクルフィルタ}を適用したアルゴリズムは\textbf{FastSLAM}とよばれる。ここでは初期のFastSLAMアルゴリズムである\textbf{FastSLAM 1.0}について記述する。

\subsection{FastSLAMが解く問題}
FastSLAMで解く完全SLAM問題は、次のような事後確率として記述される。即ち、全時刻における計測$z_{1 : t}$、制御$u_{1 : t}$、及び対応付け変数$c_{1 : t}$の下で条件付けられた、ロボットの全姿勢$x_{1 : t}$と地図$m$に関する事後確率である。地図$m$の各構成要素は$m_n$($1 \le n \le N$)のように表され、点群地図(位置ベースの地図)であれば個々の点、占有格子地図(特徴ベースの地図)であれば単一の格子を意味する。事後確率は以下のように$N + 1$個の項に分解できた。これは完全SLAM問題を、軌跡$x_{1 : t}$の推定と、地図の各構成要素$m_n$の推定という$N + 1$個の簡単な問題に分割できることを意味する。そして最初にロボットの軌跡$x_{1 : t}$のみを推定し、その軌跡の下で各要素$m_n$を推定するという、2段階の処理が可能である。
\begin{equation}
	p(x_{1 : t}, m | z_{1 : t}, u_{1 : t}, c_{1 : t}) = p(x_{1 : t} | z_{1 : t}, u_{1 : t}, c_{1 : t}) \prod_{n = 1}^N p(m_n | x_{1 : t}, z_{1 : t}, u_{1 : t}, c_{1 : t})
\end{equation}

パーティクルフィルタは、問題(対象の事後確率)の次元数に対して、指数的に計算量が増加するという特徴をもつ。事後確率を十分な精度で近似するために必要なパーティクル数は、次元の増加に伴い指数的に増えるためである。完全SLAM問題を直接解こうとすると、問題の次元数は、ロボットの全姿勢$x_{1 : t}$の次元数と、地図$m = \left\{ m_1, \cdots, m_N \right\}$の次元数を足し合わせたものとなる。地図は一般に大規模になるため、変数$m$は高次元になる。パーティクルフィルタでは、この高次元な空間を埋めるのに十分な個数のパーティクルをサンプルしなければならず、要求される計算量があまりにも膨大になる。従って、完全SLAM問題をパーティクルフィルタで直接解くことは現実的ではない。しかし完全SLAM問題を直接解く必要は全くなく、$N + 1$個の比較的簡単な問題を個別に解けばよいことが、上記の式変形から明らかになっている。\newline

FastSLAMでは\textbf{Rao-Blackwellizedパーティクルフィルタ}(RBPF)という、パーティクルフィルタの拡張が用いられる。Rao-Blackwellizedパーティクルフィルタでは、一部の変数に対する事後確率のみがパーティクルフィルタで表現され、それ以外の変数については別の(パラメトリックな)フィルタが用いられる。FastSLAMにおいては、ロボットの軌跡$x_{1 : t}$は\textbf{パーティクルフィルタ}、地図の各要素$m_n$は\textbf{カルマンフィルタ}や\textbf{バイナリベイズフィルタ}により推定される。このような手法が可能なのは、完全SLAM問題の事後確率が、個々の変数に関する項に分離されているからである。地図の要素$m_n$に関する項は、軌跡$x_{1 : t}$の下での条件付き確率$p(m_n | x_{1 : t}, z_{1 : t}, u_{1 : t}, c_{1 : t})$になっている。従って、軌跡$x_{1 : t}$の推定にパーティクルフィルタを用いると(各パーティクルがそれぞれの軌跡を保持する)、各パーティクルに対して個別に地図$m$が推定されることとなり、従ってパーティクルごとに別々の地図を持つことが分かる。パーティクルの個数を$M$とすると、フィルタの総数は$1 + MN$となる。

\subsection{FastSLAMの大まかな流れ}
FastSLAMでは、各パーティクルが軌跡と地図の双方を保持する。パーティクルの総数を$M$、時刻$t$における$k$番目のパーティクルを$Y_t^{[k]} = \left\{ x_{1 : t}^{[k]}, m^{[k]} \right\}$のように表す。時刻$t$におけるパーティクルの集合を$\mathcal{Y}_t = \left\{ Y_t^{[1]}, \cdots, Y_t^{[M]} \right\}$と書く。軌跡の推定にはパーティクルフィルタ、地図の推定にはそれ以外のパラメトリックなフィルタが用いられるので、FastSLAMアルゴリズムの大まかな流れは次のようになる。以下のアルゴリズム\ref{alg:fast-slam-outline}では、各パーティクルが保持する地図$m^{[k]}$と計測$z_t$との対応付け変数$c_t^{[k]}$は既知であるとする。また具体的な地図の表現法(点群地図や占有格子地図)については考慮していない。\newline

複数の計測データが含まれるとき($z_t = \left\{ z_t^i \right\}$)、それと同じ個数分だけ、各パーティクルは対応付け変数を持つから$c_t^{[k]} = \left\{ c_t^{[k], i} \right\}$のように記す。時刻$t$において、$i$番目の計測データ$z_t^i$が、$k$番目のパーティクルが保持する地図$m^{[k]}$の何番目の要素に対応するかを$c_t^{[k], i}$が意味するから、$c_t^{[k], i} \in \left\{ 1, \cdots, N \right\}$のようになる(地図は$N$個の要素をもつ)。時刻$t$において、$k$番目のパーティクルが持つ地図$m^{[k]}$の、$j$番目の要素を$m^{[k], j}$と表す($j \in \left\{ 1, \cdots, N \right\}$)。全てのパーティクルについて対応付け変数をまとめて$c_t = \left\{ c_t^{[1]}, \cdots, c_t^{[M]} \right\}$と書く。各パーティクルが個別に地図$m^{[k]}$と対応付け変数$c_t^{[k]}$を保持するので、複数の対応関係を同時に調べられる。事後確率が低くなるような対応関係は、リサンプリングによって除去されていくため、アルゴリズムは頑健になる。

\begin{algorithm}[H]
	\caption{FastSLAMの大まかな流れ}
	\label{alg:fast-slam-outline}
	\begin{algorithmic}[1]
		\Require
			\Statex 時刻$t - 1$におけるパーティクルのセット$\mathcal{Y}_{t - 1} = \left\{ Y_{t - 1}^{[1]}, \cdots, Y_{t - 1}^{[M]} \right\}$
			\Statex 時刻$t$における制御$u_t$
			\Statex 時刻$t$における計測$z_t$
			\Statex 時刻$t$における対応付け変数$c_t = \left\{ c_t^{[1]}, \cdots, c_t^{[M]} \right\}$

		\Ensure
			\Statex 時刻$t$におけるパーティクルのセット$\mathcal{Y}_t = \left\{ Y_t^{[1]}, \cdots, Y_t^{[M]} \right\}$ \newline
		
		\State 一時的に用いる仮のパーティクルのセット$\overline{\mathcal{Y}}_t$を空に初期化: $\overline{\mathcal{Y}}_t \leftarrow \varnothing$
		\State 時刻$t$におけるパーティクルのセット$\mathcal{Y}_t$を空に初期化: $\mathcal{Y}_t \leftarrow \varnothing$
		\For{$k = 1, 2, \cdots, M$}
			\State (\textbf{状態予測}) 時刻$t$における新たな姿勢$x_t^{[k]}$をサンプリング: $x_t^{[k]} \sim p(x_t | x_{t - 1}^{[k]}, u_t)$
			\ForEach{$i$}
				\State 時刻$t$における各計測$z_t^i$と対応付け変数$c_t^{[k], i} = j$を取り出す
				\State (\textbf{計測更新}) 計測$z_t^i$を使い、現在の姿勢の仮説$x_t^{[k]}$の下で、地図の要素$m^{[k], j}$を更新
			\EndFor
			\State (\textbf{重みの計算}) 新たなパーティクル$Y_t^{[k]} = \left\{ x_{1 : t}^{[k]}, m^{[k]} \right\}$について重み$w_t^{[k]}$を計算
			\State $\overline{\mathcal{Y}}_t$に新たなパーティクル$Y_t^{[k]}$を追加
		\EndFor
		\For{$k = 1, 2, \cdots, M$}
			\State 重み$w_t^{[i]}$に比例する確率で、パーティクル$Y_t^{[i]} \in \overline{\mathcal{Y}}_t$をサンプル($1 \le i \le M$)
			\State (\textbf{リサンプリング}) $\mathcal{Y}_t$にパーティクル$Y_t^{[i]}$を追加
		\EndFor
	\end{algorithmic}
\end{algorithm}

基本的には元々のパーティクルフィルタのアルゴリズムと同様であり、直前の時刻$t - 1$におけるパーティクルの集合$\mathcal{Y}_{t - 1}$から、新たなパーティクルの集合$\mathcal{Y}_t$が構築される。但し、計測$z_t$と対応付け変数$c_t$を使って地図$m$を更新する部分で、カルマンフィルタやバイナリベイズフィルタなどの別のフィルタも使用されるという点で異なる。アルゴリズムは最新の制御$u_t$や計測$z_t$のみを必要とするため、オンラインで完全SLAM問題が解かれる。

\subsection{カルマンフィルタの使用}
FastSLAMでは計算量を削減するために、Rao-Blackwellizedパーティクルフィルタの枠組みを用いており、ロボットの軌跡の推定にはパーティクルフィルタ、地図の推定にはその他のパラメトリックなフィルタが用いられる。ここでは地図の各要素の推定にカルマンフィルタを使うことを考える。カルマンフィルタでは、推定したい変数に関する事後確率をガウス分布で近似する。そのため事後確率の推定は、ガウス分布の2つのパラメータ(平均と共分散)の計算に置き換えられる。完全SLAM問題は、軌跡の推定と、地図の各要素の推定とに分解されるため、地図の各要素について別々にカルマンフィルタを適用すればよい。故に時刻$t$において、各パーティクル$Y_t^{[k]}$はそれぞれ、軌跡$x_{1 : t}^{[k]}$と、地図の各要素$m^{[k], j}$($1 \le j \le N$)に対する$N$個のカルマンフィルタを保持する。カルマンフィルタで推定される平均を$\mu_t^{[k], j}$、共分散行列を$\Sigma_t^{[k], j}$のように表す。$\mu_t^{[k], j}$と$\Sigma_t^{[k], j}$は、時刻$t$において$k$番目のパーティクルが保持する地図$m^{[k]}$の、$j$番目の要素$m^{[k], j}$に関する平均と共分散である。例えば地図$m$の表現に点群を用いる場合、$\mu_t^{j}$と$\Sigma_t^{j}$は、地図に登録された$j$番目の点の特徴(位置や画像の特徴量)$m^j$に関する、平均と共分散を意味している。地図の各要素について平均と共分散を推定するので、時刻$t$における$k$番目のパーティクルを具体的に次のように書く。
\begin{equation}
	m^{[k]} = \left\{ \mu_t^{[k], 1}, \Sigma_t^{[k], 1}, \mu_t^{[k], 2}, \Sigma_t^{[k], 2}, \cdots, \mu_t^{[k], N}, \Sigma_t^{[k], N} \right\}
\end{equation}
\begin{equation}
	Y_t^{[k]} = \left\{ x_{1 : t}^{[k]}, \mu_t^{[k], 1}, \Sigma_t^{[k], 1}, \mu_t^{[k], 2}, \Sigma_t^{[k], 2}, \cdots, \mu_t^{[k], N}, \Sigma_t^{[k], N} \right\}
\end{equation}

パーティクルは合計$M$個あり、各パーティクルが$N$個のカルマンフィルタを保持するため、1回のアルゴリズムでカルマンフィルタの計算が$MN$回実行される。カルマンフィルタを使用するとき、アルゴリズム\ref{alg:fast-slam-outline}において計測更新とした部分が、カルマンフィルタの計算に置き換わる。以下ではFastSLAM 1.0アルゴリズムについて、状態予測、計測更新、重みの計算、リサンプリングの順に記述する。\newline

既にアルゴリズム\ref{alg:fast-slam-outline}に示したように、前時刻における各パーティクル$Y_t^{[k]} = \left\{ x_{1 : t - 1}^{[k]}, m^{[k]} \right\} \in \mathcal{Y}_{t - 1}$について、新たな姿勢$x_t^{[k]}$が状態遷移確率$p(x_t | x_{t - 1}^{[k]}, u_t)$からサンプリングされる(\textbf{状態予測})。$x_{t - 1}^{[k]}$は$k$番目のパーティクルが保持する、時刻$t - 1$における姿勢の事後推定である。サンプリングされた新たな姿勢$x_t^{[k]}$は、$k$番目のパーティクルに加えられる。\newline

続いて、計測$z_t$と対応付け変数$c_t^{[k]}$、並びに推定された状態$x_t^{[k]}$を用いて、パーティクル$k$が保持する地図$m^{[k]}$の平均と共分散が更新される(\textbf{計測更新})。この処理は、時刻$t$における各計測$z_t^i \in z_t$について行われる。計測$z_t^i$について、$k$番目のパーティクルが保持する地図$m^{[k]}$の何番目の要素を観測したものであるかを、対応付け変数$c_t^{[k], i} = j$により参照する($1 \le j \le N$)。計測$z_t^i$と対応するのは$j$番目の要素だと分かるので、$m^{[k], j}$の事後確率を表現するパラメータ$\mu_t^{[k], j}$と$\Sigma_t^{[k], j}$をカルマンフィルタにより更新する。$m^{[k], j}$の事後確率は、完全SLAM問題の分解で得られる項の一つであり、次のようにガウス分布で近似された。
\begin{equation}
	p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t}, u_{1 : t}, c_{1 : t}^{[k]}) = p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t - 1}, z_t^i, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i}) = \mathcal{N}(m^{[k], j} | \mu_t^{[k], j}, \Sigma_t^{[k], j})
\end{equation}
これは以下のように、$z_t^i$の計測確率$p(z_t^i | x_t^{[k]}, m^{[k], j}, c_t^{[k], i})$と、一時刻前の$m^{[k], j}$の事後確率の積として記述できる。
\begin{eqnarray}
	&& p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t}, u_{1 : t}, c_{1 : t}^{[k]}) \nonumber \\
	&=& p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t - 1}, z_t^i, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i}) \nonumber \\
	&=& \frac{p(z_t^i | m^{[k], j}, x_{1 : t}^{[k]}, z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i}) p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i})}{p(z_t^i | x_{1 : t}^{[k]}, z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i})} \nonumber \\
	&=& \eta \ p(z_t^i | m^{[k], j}, x_t^{[k]}) p(m^{[k], j} | x_{1 : t - 1}^{[k]}, z_{1 : t - 1}, u_{1 : t - 1}, c_{1 : t - 1}^{[k]})
\end{eqnarray}
$\eta = p(z_t^i | x_{1 : t}^{[k]}, z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1}^{[k]}, c_t^{[k], i})$は$m^{[k], j}$には依存しない定数項である。また最後の式変形では、計測$z_t^i$は地図の$c_t^{[k], i} = j$番目の要素$m^{[k], j}$、現在の姿勢$x_t^{[k]}$、対応付け変数$c_t^{[k], i}$のみによって決まるので、それ以外の変数は除去している(変数$c_t^{[k], i} = j$も$m^{[k], j}$に含まれるので不要)。更に、時刻$t - 1$までの計測を条件とする$m^{[k], j}$の事後確率は、時刻$t$における制御$u_t$や姿勢$x_t^{[k]}$とは無関係であることを利用した。時刻$t$での計測が得られて初めて、姿勢$x_t^{[k]}$や制御$u_t$が、地図$m^{[k], j}$に対して意味を持つようになる。$c_t^{[k], i} = j$となるような$i$が複数存在するとき、即ち$j$番目の要素を観測した複数の計測データがあるとき、$m^{[k], j}$の事後確率は次のようにできる。
\begin{eqnarray}
	&& p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t}, u_{1 : t}, c_{1 : t}^{[k]}) \nonumber \\
	&=& \eta \ \left[ \prod_i p(z_t^i | m^{[k], j}, x_t^{[k]}) \right] p(m^{[k], j} | x_{1 : t - 1}^{[k]}, z_{1 : t - 1}, u_{1 : t - 1}, c_{1 : t - 1}^{[k]})
\end{eqnarray}
上記の積は、$j$番目の要素を観測した、全ての計測データのインデックス$i$についてである。各計測データ$z_t^i$が互いに独立であるという強い仮定に基づいている。さて、カルマンフィルタを基に、時刻$t$における事後確率の平均$\mu_t^{[k], j}$と共分散$\Sigma_t^{[k], j}$の更新式を導出する。カルマンフィルタの計算を可能にするためには、任意の時刻$t$において事後確率がガウス分布でなければならない。上記の漸化式において、第2項の事後確率だけでなく、第1項の計測確率$p(z_t^i | m^{[k], j}, x_t^{[k]})$もガウス分布に従う必要がある。計測は、次のような線形ガウスモデルで記述されるとする。
\begin{equation}
	z_t^i = h(m^{[k], j}, x_t^{[k]}) + \delta_t
\end{equation}
時刻$t$における$i$番目の計測$z_t^i$は、現在のロボットの姿勢$x_t^{[k]}$と、観測されたはずの地図の要素$m^{[k], j}$から予想される計測に、ガウスノイズ$\delta_t$を足し合わせたものである。現在の姿勢$x_t^{[k]}$と地図の要素$m^{[k], j}$から計測値$z_t^i$を逆算するのは、非線形関数$h(m^{[k], j}, x_t^{[k]})$によって行われる。$\delta_t$は、平均が零ベクトルで共分散行列が$Q_t$のガウス分布$\mathcal{N}(\delta_t | 0, Q_t)$に従う。雑音$\delta_t$がガウス分布に従っていても、関数$h$が非線形であるため、計測$z_t^i$は一般にガウス分布にならない。それでは困るので、1次のテイラー展開を用いて、非線形関数$h$を次に示すように線形化する。
\begin{eqnarray}
	h(m^{[k], j}, x_t^{[k]}) &\simeq& h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) + h'(\mu_{t - 1}^{[k], j}, x_t^{[k]}) \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right) \\
	&=& h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) + H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right)
\end{eqnarray}
上式は、関数$h(m^{[k], j}, x_t^{[k]})$を$\mu_{t - 1}^{[k], j}$のまわりでテイラー展開し、1次の項までで打ち切ったものである。$\mu_{t - 1}^{[k], j}$のまわりで行うのは、地図の要素$m^{[k], j}$を更新する時点で、ロボットが考えている最尤な値が$\mu_{t - 1}^{[k], j}$だからである。$h'(\mu_{t - 1}^{[k], j}, x_t^{[k]})$は、関数$h$の$m^{[k], j}$による偏導関数に、$\mu_{t - 1}^{[k], j}$を代入したものである。このヤコビ行列は定数項であるため$H_t^{[k], j}$と表す。ヤコビ行列は、各パーティクルが持つ地図$m^{[k]}$の各要素に対して存在し、時間の経過と共に変化していく。
\begin{equation}
	H_t^{[k], j} = h'(\mu_{t - 1}^{[k], j}, x_t^{[k]}) = \nabla h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) = \left. \frac{\partial h(m^{[k], j}, x_t^{[k]})}{\partial m^{[k], j}} \right|_{m^{[k], j} = \mu_{t - 1}^{[k], j}}
\end{equation}
これより計測$z_t^i$は、次のように$m^{[k], j}$についての線形関数として近似される。パーティクル$k$がもつ姿勢$x_t^{[k]}$は、パーティクルフィルタの状態予測において、状態遷移確率$p(x_t | x_{t - 1}^{[k]}, u_t)$からサンプリングされている。従って、カルマンフィルタによる地図推定の段階では、ロボットの姿勢$x_t^{[k]}$は既知の定数として扱われる。ロボットの状態$x_t$と、制御$u_t$や計測$z_t$との関係(状態$x_t$が更新される過程)は、状態遷移(状態の予測に関係)と計測(予測の修正に関係)の2つの式で表現された。しかし地図の要素$m^{[k], j}$のモデル(更新過程)は、以下の計測の式だけで表現され、制御$u_t$とは直接の関係が存在しない。従って、姿勢をカルマンフィルタで推定するときとは異なり、地図の各要素を推定するとき、事前確率に基づいた予測は不要であり、カルマンゲインの計算と、計測に基づく修正のみを実行すればよい。
\begin{equation}
	z_t^i \simeq h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) + H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right) + \delta_t
\end{equation}
ガウス雑音$\delta_t$の分布に$\delta_t = z_t^i - h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) - H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right)$を代入する。
\begin{eqnarray}
	p(\delta_t) &=& \mathcal{N}(\delta_t | 0, Q_t) \nonumber \\
	&=& |2 \pi Q_t|^{-\frac{1}{2}} \exp \left\{ -\frac{1}{2} \delta_t^T Q_t^{-1} \delta_t \right\} \nonumber \\
	&=& |2 \pi Q_t|^{-\frac{1}{2}} \exp \left\{ -\frac{1}{2} \left( z_t^i - h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) - H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right) \right)^T Q_t^{-1} \right. \nonumber \\
	&& \qquad \left( z_t^i - h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) - H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right) \right) \bigg\} \nonumber
\end{eqnarray}
これより計測$z_t^i$が、平均$h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) + H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right)$、共分散行列$Q_t$のガウス分布となる。
\begin{equation}
	p(z_t^i) = \mathcal{N} \left( z_t^i | h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) + H_t^{[k], j} \left( m^{[k], j} - \mu_{t - 1}^{[k], j} \right), Q_t \right)
\end{equation}
関数$h$の線形近似により、拡張カルマンフィルタの枠組みを使って、平均$\mu_t^{[k], j}$と共分散$\Sigma_t^{[k], j}$の更新式が以下のように得られる。1行目では、時刻$t$において$k$番目のパーティクルがもつ地図の、$j$番目の要素$m^{[k], j}$について、カルマンゲイン$K_t^{[k], j}$を計算する。続いて2行目と3行目では、地図の要素$m^{[k], j}$に関する事後確率の、平均$\mu_t^{[k], j}$と共分散行列$\Sigma_t^{[k], j}$を計算する。
\begin{eqnarray}
	K_t^{[k], j} &=& \Sigma_{t - 1}^{[k], j} H_t^{{[k], j}^T} \left( H_t^{[k], j} \Sigma_{t - 1}^{[k], j} H_t^{{[k], j}^T} + Q_t \right)^{-1} \\
	\mu_t^{[k], j} &=& \mu_{t - 1}^{[k], j} + K_t^{[k], j} \left( z_t^i - h(\mu_{t - 1}^{[k], j}, x_t^{[k]}) \right) \\
	\Sigma_t^{[k], j} &=& \left( I - K_t^{[k], j} H_t^{[k], j} \right) \Sigma_{t - 1}^{[k], j}
\end{eqnarray}
拡張カルマンフィルタのアルゴリズムは、3ステップの計算(予測、カルマンゲインの計算、計測を用いた修正)を順に行うものであった。しかし上記の計算式は最後の2ステップのみであり、最初のステップ(状態予測)は省かれている。その理由は、地図の要素$m^{[k], j}$の事後確率を観察すれば明らかである。時刻$t$における事後確率は、直前の時刻$t - 1$における事後確率に、$z_t^i$の計測確率を乗算して正規化すれば求められる。ロボットの姿勢$x_t$のように、制御$u_t$を用いて、地図の要素$m^{[k], j}$に関する事前確率を計算し、$m^{[k], j}$の平均と共分散に関して事前に予測を立てる必要はない。$m^{[k], j}$の更新に利用できるのは計測$z_t$のみである。従って、拡張カルマンフィルタで$m^{[k], j}$を推定するとき、最初のステップの計算(制御$u_t$を用いた予測)は現れない。
\begin{equation}
	p(m^{[k], j} | x_{1 : t}^{[k]}, z_{1 : t}, u_{1 : t}, c_{1 : t}^{[k]}) = \eta \ p(z_t^i | m^{[k], j}, x_t^{[k]}) p(m^{[k], j} | x_{1 : t - 1}^{[k]}, z_{1 : t - 1}, u_{1 : t - 1}, c_{1 : t - 1}^{[k]}) \nonumber
\end{equation}
ロボットの姿勢$x_t$の推定であれば、カルマンゲインの計算と修正ステップでは、予測ステップで得られた事前確率の平均$\overline{\mu}_t$と共分散行列$\overline{\Sigma}_t$を計算に用いていた。地図のパラメータ$\mu_t^{[k], j}$と$\Sigma_t^{[k], j}$の更新式をみると、予測ステップが存在しないので、直前の時刻における値$\mu_{t - 1}^{[k], j}$と$\Sigma_{t - 1}^{[k], j}$が予測値の代わりに用いられている。\newline

カルマンフィルタによって更新されるのは、時刻$t$でロボットが観測した地図の要素だけである。もう少し具体的には、$i$番目の計測データ$z_t^i$について、対応付け変数$c_t^{[k], i} = j$が指し示す地図の要素$m^{[k], j}$のみが更新される。時刻$t$で観測されなかった地図の要素$m^{[k], j}$については、以前の時刻におけるパラメータ$\mu_t^{[k], j}, \ \Sigma_t^{[k], j}$をそのまま引き継ぐだけであり($\mu_t^{[k], j} = \mu_{t - 1}^{[k], j}, \ \Sigma_t^{[k], j} = \Sigma_{t - 1}^{[k], j}$)、要素$m^{[k], j}$に関する推定は更新されない。\newline

計測データ$z_t$によって、各パーティクル$Y_t^{[k]}$がもつ地図$m^{[k]}$が更新された後、パーティクルの重み$w_t^{[k]}$が計算される(\textbf{重みの計算})。以前の時刻におけるパーティクルのセット$\mathcal{Y}_{t - 1}$について、各パーティクル$Y_{t - 1}^{[k]}$が持つ軌跡の集合$\left\{ x_{1 : t - 1}^{[1]}, \cdots, x_{1 : t - 1}^{[M]} \right\}$は、確率分布$p(x_{1 : t - 1} | z_{1 : t - 1}, u_{1 : t - 1}, c_{1 : t - 1})$の近似表現になっていると仮定する。$\mathcal{Y}_{t - 1}$に属する全てのパーティクルについて、状態予測と計測更新の処理を行うと、一時的なパーティクルのセット$\overline{\mathcal{Y}}_t$を作成できる。$\overline{\mathcal{Y}}_t$についても、各パーティクルが保持する軌跡の集合$\left\{ x_{1 : t}^{[1]}, \cdots, x_{1 : t}^{[M]} \right\}$を考える。これらの軌跡$x_{1 : t}^{[k]}$は全て、状態遷移確率$p(x_t | x_{t - 1}^{[k]}, u_t) = p(x_t | x_{1 : t - 1}^{[k]}, u_t)$からサンプリングして得たものである。そのため軌跡の集合$\left\{ x_{1 : t}^{[1]}, \cdots, x_{1 : t}^{[M]} \right\}$は、以下の確率分布の近似的な表現となっている。
\begin{equation}
	p(x_{1 : t}^{[k]} | z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1}) = p(x_t^{[k]} | x_{t - 1}^{[k]}, u_t) p(x_{1 : t - 1}^{[k]} | z_{1 : t - 1}, u_{1 : t - 1}, c_{1 : t - 1})
\end{equation}
完全SLAM問題の分解から分かるように、軌跡$x_{1 : t}$については、パーティクルの集合が確率分布$p(x_{1 : t} | z_{1 : t}, u_{1 : t}, c_{1 : t})$の近似表現となってほしい。軌跡を表すパーティクルの集合は$p(x_{1 : t}^{[k]} | z_{1 : t - 1}, u_{1 : t}, c_{1 : t - 1})$の近似であるから、変数$z_t$と$c_t$についてはまだ考慮されていない。

\end{document}
